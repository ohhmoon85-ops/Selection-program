<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í•œì˜ì í¬ë§ ì¥í•™ì¬ë‹¨ | ì¥í•™ìƒ ì„ ë°œ ì‹œìŠ¤í…œ</title>
  <!-- Bootstrap 5 -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --navy: #0d1b5e;
      --navy2: #1a3a8f;
      --gold:  #c9a227;
    }
    body { background: #f5f7fb; font-family: 'Segoe UI', sans-serif; }

    /* â”€â”€ í—¤ë” â”€â”€ */
    .site-header {
      background: linear-gradient(135deg, var(--navy), var(--navy2));
      color: #fff; padding: 2rem 1.5rem; text-align: center;
      border-radius: 0 0 16px 16px; margin-bottom: 1.5rem;
      box-shadow: 0 4px 20px rgba(13,27,94,.3);
    }
    .site-header h1 { font-size: 2rem; font-weight: 900; letter-spacing: 2px; margin: 0; }
    .site-header p  { margin: .3rem 0 0; opacity: .8; font-size: .9rem; }

    /* â”€â”€ íƒ­ â”€â”€ */
    .nav-tabs .nav-link          { color: #555; font-weight: 600; }
    .nav-tabs .nav-link.active   { color: var(--navy); border-bottom: 3px solid var(--navy); }

    /* â”€â”€ ì¹´ë“œ â”€â”€ */
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.08); }
    .card-header { background: var(--navy); color: #fff; border-radius: 12px 12px 0 0 !important; font-weight: 700; }
    .metric-card { border-left: 5px solid var(--navy); }
    .metric-card .display-6 { color: var(--navy); }

    /* â”€â”€ ì—…ë¡œë“œ ì¡´ â”€â”€ */
    .upload-zone {
      border: 2px dashed #aab4cc; border-radius: 12px;
      padding: 2.5rem; text-align: center; cursor: pointer;
      transition: background .2s;
    }
    .upload-zone:hover, .upload-zone.dragover { background: #e8ecf8; border-color: var(--navy2); }
    .upload-zone i { font-size: 3rem; color: #aab4cc; }

    /* â”€â”€ í…Œì´ë¸” â”€â”€ */
    .table-scroll { overflow-x: auto; max-height: 540px; overflow-y: auto; }
    .table thead { position: sticky; top: 0; z-index: 10; }
    .table thead th { background: var(--navy); color: #fff; white-space: nowrap; }
    .rank-1 { background: rgba(255,215,0,.25) !important; font-weight: 700; }
    .rank-2 { background: rgba(192,192,192,.25) !important; font-weight: 700; }
    .rank-3 { background: rgba(205,127,50,.25) !important; font-weight: 700; }
    .check-mark { color: #198754; font-weight: 700; }

    /* â”€â”€ ë³´ê³ ì„œ ë°•ìŠ¤ â”€â”€ */
    .report-box {
      background: #eef2ff; border-left: 5px solid var(--navy);
      padding: 1.4rem 1.8rem; border-radius: 8px; line-height: 1.9;
    }

    /* â”€â”€ ë¡œë”© â”€â”€ */
    #loadingSection { display: none; }

    /* â”€â”€ í‘¸í„° â”€â”€ */
    footer { text-align: center; color: #888; font-size: .82rem; padding: 1.5rem 0 2rem; }

    /* â”€â”€ ë¡œê·¸ â”€â”€ */
    .log-box {
      background: #1e1e2e; color: #a9b1d6; font-family: monospace;
      font-size: .78rem; padding: 1rem; border-radius: 8px;
      max-height: 240px; overflow-y: auto; white-space: pre;
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• í—¤ë” â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="site-header">
  <h1>ğŸ“ í•œì˜ì í¬ë§ ì¥í•™ì¬ë‹¨</h1>
  <p>ì¥í•™ìƒ ìë™ ì„ ë°œ ì‹œìŠ¤í…œ &nbsp;|&nbsp; í›„ì›ì‚¬: ì‚¼ì–‘</p>
  <p style="font-size:.8rem;opacity:.65;">ìˆ˜ì—¬ì‹: 2026ë…„ 4ì›” 30ì¼ &nbsp;Â·&nbsp; ì´ì‚¬ì¥: ì „ë™ì§„ &nbsp;Â·&nbsp; ì‚¬ë¬´êµ­ì¥: ì„ì¬ì˜</p>
</div>

<div class="container-fluid px-4" style="max-width:1280px;">

  <!-- ì•Œë¦¼ ì˜ì—­ -->
  <div id="alertBox"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ­ ë„¤ë¹„ê²Œì´ì…˜ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <ul class="nav nav-tabs mb-3" id="mainTab">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#tabUpload">
        <i class="bi bi-upload"></i> ì„œë¥˜ ì—…ë¡œë“œ
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#tabResult">
        <i class="bi bi-trophy"></i> ì„ ë°œ ê²°ê³¼
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#tabStats">
        <i class="bi bi-bar-chart-line"></i> í†µê³„ ë¦¬í¬íŠ¸
      </a>
    </li>
  </ul>

  <div class="tab-content">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ­ 1: ì—…ë¡œë“œ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-pane fade show active" id="tabUpload">
      <div class="row g-3">

        <!-- ì—…ë¡œë“œ ì¹´ë“œ -->
        <div class="col-lg-7">
          <div class="card">
            <div class="card-header"><i class="bi bi-folder-plus"></i> ì„œë¥˜ ZIP ì—…ë¡œë“œ</div>
            <div class="card-body">
              <p class="text-muted small mb-3">
                ì‹ ì²­ìë³„ í´ë”ì— <strong>4ì¢… ì„œë¥˜</strong>(ìë¦½ì§€ì› ëŒ€ìƒì í™•ì¸ì„œ, ì¬í•™ì¦ëª…ì„œ,
                ì„±ì ì¦ëª…ì„œ, ê°€ì‚°ì  ì„œë¥˜)ê°€ ë‹´ê¸´ ZIP íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.
              </p>
              <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-file-earmark-zip"></i>
                <p class="mt-2 mb-0 fw-semibold">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ZIP íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                <p class="text-muted small">ìµœëŒ€ 50MB</p>
              </div>
              <input type="file" id="fileInput" accept=".zip" class="d-none" onchange="onFileSelect(this)" />
              <div id="fileInfo" class="mt-2 small text-success d-none"></div>

              <div class="d-flex gap-2 mt-3">
                <button class="btn btn-primary flex-grow-1" id="uploadBtn" onclick="uploadFile()" disabled>
                  <i class="bi bi-search"></i> ë¶„ì„ ì‹œì‘
                </button>
                <button class="btn btn-outline-secondary flex-grow-1" onclick="runDemo()">
                  <i class="bi bi-flask"></i> ë°ëª¨ í…ŒìŠ¤íŠ¸
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ì•ˆë‚´ ì¹´ë“œ -->
        <div class="col-lg-5">
          <div class="card h-100">
            <div class="card-header"><i class="bi bi-info-circle"></i> ì„ ë°œ ê¸°ì¤€ ì•ˆë‚´</div>
            <div class="card-body small">
              <table class="table table-sm table-bordered mb-2">
                <thead class="table-light"><tr><th>í•­ëª©</th><th>ë°°ì </th></tr></thead>
                <tbody>
                  <tr><td>í•™ë…„ ì ìˆ˜</td><td>ìµœëŒ€ 50ì </td></tr>
                  <tr><td>í•™ì—… ì´ìˆ˜ìœ¨</td><td>ìµœëŒ€ 50ì </td></tr>
                  <tr><td>ê°€ì‚°ì </td><td>ìµœëŒ€ 10ì </td></tr>
                </tbody>
              </table>
              <p class="fw-semibold mb-1">í•™ë…„ë³„ ì ìˆ˜</p>
              <ul class="mb-2">
                <li>4í•™ë…„ â†’ 50ì  &nbsp;|&nbsp; 3í•™ë…„ â†’ 35ì </li>
                <li>2í•™ë…„ â†’ 20ì  &nbsp;|&nbsp; 1í•™ë…„ â†’ 5ì </li>
              </ul>
              <p class="fw-semibold mb-1">ê°€ì‚°ì  ì„¸ë¶€</p>
              <ul class="mb-2">
                <li>ì´ê³µê³„/ë°©ì‚° ì „ê³µ â†’ <span class="text-success fw-bold">+5</span></li>
                <li>êµ­ê°€ìê²©ì¦/ì–´í•™ â†’ <span class="text-success fw-bold">+3</span></li>
                <li>ë´‰ì‚¬ 50h ì´ìƒ â†’ <span class="text-success fw-bold">+2</span></li>
              </ul>
              <div class="alert alert-warning py-2 mb-0 small">
                <i class="bi bi-shield-lock"></i>
                ì£¼ë¯¼ë²ˆí˜¸ ë“± ë¯¼ê° ì •ë³´ëŠ” ì¶”ì¶œ ì¦‰ì‹œ ë§ˆìŠ¤í‚¹ë©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>

        <!-- ì´ì „ ì„ ë°œì ì œì™¸ í˜„í™© -->
        <div class="col-12">
          <div class="d-flex align-items-center gap-2 p-2 border rounded bg-white">
            <div class="flex-grow-1" id="excludeStatus"></div>
            <button class="btn btn-outline-danger btn-sm d-none" id="excludeClearBtn" onclick="clearExcluded()"><i class="bi bi-x-circle"></i> ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- ZIP êµ¬ì¡° ì•ˆë‚´ -->
        <div class="col-12">
          <div class="card">
            <div class="card-header"><i class="bi bi-folder-symlink"></i> ZIP íŒŒì¼ êµ¬ì¡° ì˜ˆì‹œ</div>
            <div class="card-body">
              <pre class="mb-0 small bg-light p-3 rounded">ğŸ“¦ ì‹ ì²­ì„œë¥˜.zip
â”œâ”€â”€ í™ê¸¸ë™/
â”‚   â”œâ”€â”€ ìë¦½ì§€ì›ëŒ€ìƒìí™•ì¸ì„œ.pdf
â”‚   â”œâ”€â”€ ì¬í•™ì¦ëª…ì„œ.pdf
â”‚   â”œâ”€â”€ ì„±ì ì¦ëª…ì„œ.pdf
â”‚   â””â”€â”€ ê°€ì‚°ì ì„œë¥˜.pdf
â””â”€â”€ ê¹€ì² ìˆ˜/
    â””â”€â”€ ...</pre>
              <p class="mt-2 mb-0 text-muted small">
                â€» <strong>ìë¦½ì§€ì› ëŒ€ìƒì í™•ì¸ì„œ</strong>ê°€ ì—†ëŠ” ì‹ ì²­ìëŠ” ìë™ìœ¼ë¡œ ì„ ë°œ ëŒ€ìƒì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ë¡œë”© -->
      <div id="loadingSection" class="text-center py-5">
        <div class="spinner-border text-primary" style="width:3rem;height:3rem;"></div>
        <p class="mt-3 fw-semibold text-secondary" id="loadingText">ì„œë¥˜ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
      </div>

      <!-- ì²˜ë¦¬ ë¡œê·¸ -->
      <div class="mt-3 d-none" id="logSection">
        <div class="accordion">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#logCollapse">
                <i class="bi bi-journal-text me-2"></i> ì²˜ë¦¬ ë¡œê·¸ (íˆ¬ëª…ì„± ì›ì¹™ì— ë”°ë¥¸ ì²˜ë¦¬ ì´ë ¥)
              </button>
            </h2>
            <div id="logCollapse" class="accordion-collapse collapse">
              <div class="accordion-body p-0">
                <div class="log-box" id="logContent"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /tabUpload -->

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ­ 2: ì„ ë°œ ê²°ê³¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-pane fade" id="tabResult">
      <div id="resultEmpty" class="text-center text-muted py-5">
        <i class="bi bi-arrow-left-circle" style="font-size:2rem;"></i>
        <p class="mt-2">'ì„œë¥˜ ì—…ë¡œë“œ' íƒ­ì—ì„œ ë¶„ì„ì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.</p>
      </div>

      <div id="resultContent" class="d-none">
        <!-- ì„ ë°œ ê³µê³  í—¤ë” -->
        <div class="alert alert-success d-flex align-items-start mb-3" id="resultBanner">
          <i class="bi bi-trophy-fill me-2 mt-1" style="font-size:1.3rem;"></i>
          <div>
            <strong>2026ë…„ë„ í•œì˜ì í¬ë§ ì¥í•™ì¬ë‹¨ ì¥í•™ìƒ ìµœì¢… ì„ ë°œ ëª…ë‹¨</strong>
            <div class="small text-muted mt-1" id="resultMeta"></div>
          </div>
        </div>

        <!-- ìš”ì•½ ë©”íŠ¸ë¦­ -->
        <div class="row g-2 mb-3" id="resultMetrics"></div>

        <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
        <div class="d-flex gap-2 mb-3 flex-wrap">
          <button class="btn btn-success btn-sm" onclick="downloadCSV('selected')">
            <i class="bi bi-download"></i> ì„ ë°œ ëª…ë‹¨ CSV
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="downloadCSV('all')">
            <i class="bi bi-download"></i> ì „ì²´ ìê²©ì CSV
          </button>
        </div>

        <!-- ì„ ë°œ ê²°ê³¼ í…Œì´ë¸” -->
        <div class="card mb-3">
          <div class="card-header">
            <i class="bi bi-table"></i> ìµœì¢… ì„ ë°œ ëª…ë‹¨
          </div>
          <div class="card-body p-0">
            <div class="table-scroll">
              <table class="table table-hover table-sm mb-0" id="resultTable">
                <thead>
                  <tr>
                    <th>ìˆœìœ„</th><th>ì„±ëª…</th><th>í•™ë…„</th><th>ì „ê³µ</th>
                    <th>ì´ìˆ˜í•™ì </th><th>ì¡¸ì—…ê¸°ì¤€</th><th>ì´ìˆ˜ìœ¨(%)</th><th>GPA</th>
                    <th>í•™ë…„ì ìˆ˜</th><th>ì´ìˆ˜ìœ¨ì ìˆ˜</th><th>ê°€ì‚°ì </th><th>ì´ì </th>
                    <th>ì´ê³µê³„</th><th>ìê²©ì¦</th><th>ë´‰ì‚¬</th>
                  </tr>
                </thead>
                <tbody id="resultTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- íŒŒì‹± ê²½ê³  -->
        <div id="warningSection" class="d-none">
          <div class="accordion">
            <div class="accordion-item border-warning">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-warning bg-opacity-10"
                  type="button" data-bs-toggle="collapse" data-bs-target="#warnCollapse">
                  <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
                  <span id="warnCount"></span>
                </button>
              </h2>
              <div id="warnCollapse" class="accordion-collapse collapse">
                <div class="accordion-body p-0">
                  <table class="table table-sm mb-0" id="warnTable">
                    <thead><tr><th>ì„±ëª…</th><th>ì£¼ì˜ì‚¬í•­</th></tr></thead>
                    <tbody id="warnTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /tabResult -->

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ­ 3: í†µê³„ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-pane fade" id="tabStats">
      <div id="statsEmpty" class="text-center text-muted py-5">
        <i class="bi bi-arrow-left-circle" style="font-size:2rem;"></i>
        <p class="mt-2">'ì„œë¥˜ ì—…ë¡œë“œ' íƒ­ì—ì„œ ë¶„ì„ì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.</p>
      </div>

      <div id="statsContent" class="d-none">
        <!-- í•µì‹¬ ì§€í‘œ -->
        <div class="row g-2 mb-3" id="statsMetrics"></div>

        <!-- ì°¨íŠ¸ í–‰ -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header"><i class="bi bi-bar-chart"></i> í•™ë…„ë³„ ì„ ë°œ ì¸ì›</div>
              <div class="card-body"><canvas id="gradeChart" height="220"></canvas></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header"><i class="bi bi-graph-up"></i> ì„ ë°œì ì ìˆ˜ ë¶„í¬</div>
              <div class="card-body"><canvas id="scoreChart" height="220"></canvas></div>
            </div>
          </div>
        </div>

        <!-- ê°€ì‚°ì  í˜„í™© -->
        <div class="row g-2 mb-3" id="bonusMetrics"></div>

        <!-- ê³µì‹ ë³´ê³ ì„œ -->
        <div class="card">
          <div class="card-header"><i class="bi bi-file-earmark-text"></i> ì„ ë°œ ì·¨ì§€ ë³´ê³ ì„œ</div>
          <div class="card-body">
            <div class="report-box" id="reportBox"></div>
          </div>
        </div>
      </div>
    </div><!-- /tabStats -->

  </div><!-- /tab-content -->
</div><!-- /container -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• í‘¸í„° â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer>
  í•œì˜ì í¬ë§ ì¥í•™ì¬ë‹¨ ì¥í•™ìƒ ì„ ë°œ ì‹œìŠ¤í…œ &nbsp;|&nbsp;
  ì´ì‚¬ì¥ ì „ë™ì§„ å° &nbsp;Â·&nbsp; ì‚¬ë¬´êµ­ì¥ ì„ì¬ì˜ å°<br>
  ë³¸ ì‹œìŠ¤í…œì€ ã€Œê°œì¸ì •ë³´ë³´í˜¸ë²•ã€ì— ë”°ë¼ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ë“± ë¯¼ê° ì •ë³´ë¥¼ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬í•©ë‹ˆë‹¤.
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ì—­ ìƒíƒœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let G = { selected: [], all: [], stats: null };
let gradeChartInst = null, scoreChartInst = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íŒŒì¼ ì„ íƒ / ë“œë˜ê·¸ì•¤ë“œë¡­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onFileSelect(input) {
  const file = input.files[0];
  if (!file) return;
  const info = document.getElementById('fileInfo');
  info.textContent = `âœ… ${file.name}  (${(file.size/1024).toFixed(1)} KB)`;
  info.classList.remove('d-none');
  document.getElementById('uploadBtn').disabled = false;
}

const zone = document.getElementById('uploadZone');
zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('dragover'); });
zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
zone.addEventListener('drop', e => {
  e.preventDefault(); zone.classList.remove('dragover');
  const dt = new DataTransfer();
  dt.items.add(e.dataTransfer.files[0]);
  const fi = document.getElementById('fileInput');
  fi.files = dt.files;
  onFileSelect(fi);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì—…ë¡œë“œ & API í˜¸ì¶œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function uploadFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return;
  const form = new FormData();
  form.append('file', file);
  await callAPI('/api/upload', form);
}

async function runDemo() {
  await callAPI('/api/demo', new FormData(), 'ë°ëª¨ ë°ì´í„°ë¡œ ë¶„ì„ ì¤‘...');
}

async function callAPI(url, body, loadingMsg = 'ì„œë¥˜ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...') {
  if(url==='/api/upload') { body.append('excluded_names', JSON.stringify([...loadExcluded()])); }
  setLoading(true, loadingMsg);
  clearAlert();
  try {
    const res  = await fetch(url, { method: 'POST', body });
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
    processData(data);
    showAlert('success',
      `ğŸ‰ ë¶„ì„ ì™„ë£Œ! ì´ <strong>${data.total_applicants}ëª…</strong> ì‹ ì²­ì ì¤‘
       <strong>${data.selected_count}ëª…</strong> ìµœì¢… ì„ ë°œ`
       + (data.is_demo ? ' <span class="badge bg-warning text-dark">ë°ëª¨</span>' : ''));
    // ê²°ê³¼ íƒ­ìœ¼ë¡œ ìë™ ì´ë™
    new bootstrap.Tab(document.querySelector('[href="#tabResult"]')).show();
  } catch(e) {
    showAlert('danger', 'âŒ ' + e.message);
  } finally {
    setLoading(false);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°ì´í„° ì²˜ë¦¬ â†’ ì „ì²´ UI ê°±ì‹ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function processData(data) {
  G.selected = data.results      || [];
  G.all      = data.all_results  || [];
  G.stats    = data.stats        || {};
  G.warnings = data.warnings     || [];
  G.log      = data.log          || '';
  G.total    = data.total_applicants;
  G.eligible = data.eligible_count;

  if(!data.is_demo && G.selected.length>0) addToExcluded(G.selected.map(r=>r['ì„±ëª…']));

  renderResultTab(data);
  renderStatsTab(data.stats);

  // ë¡œê·¸
  if (G.log) {
    document.getElementById('logContent').textContent = G.log;
    document.getElementById('logSection').classList.remove('d-none');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íƒ­ 2: ì„ ë°œ ê²°ê³¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResultTab(data) {
  document.getElementById('resultEmpty').classList.add('d-none');
  document.getElementById('resultContent').classList.remove('d-none');

  // ë©”íƒ€ ì •ë³´
  const now = new Date();
  document.getElementById('resultMeta').innerHTML =
    `ì„ ë°œ ê¸°ì¤€ì¼: ${now.toLocaleDateString('ko-KR')} &nbsp;|&nbsp; ` +
    `ìˆ˜ì—¬ì‹: 2026ë…„ 4ì›” 30ì¼ &nbsp;|&nbsp; ì´ì‚¬ì¥ ì „ë™ì§„ å° &nbsp;|&nbsp; ì‚¬ë¬´êµ­ì¥ ì„ì¬ì˜ å°`;

  // ìš”ì•½ ë©”íŠ¸ë¦­
  document.getElementById('resultMetrics').innerHTML = makeMetrics([
    { label: 'ì´ ì‹ ì²­ì', value: data.total_applicants + 'ëª…', icon: 'people' },
    { label: 'ìê²© ì¶©ì¡±', value: data.eligible_count + 'ëª…',   icon: 'person-check' },
    { label: 'ìµœì¢… ì„ ë°œ', value: data.selected_count + 'ëª…',   icon: 'trophy',  color: 'text-success' },
  ]);

  // ê²°ê³¼ í…Œì´ë¸”
  const tbody = document.getElementById('resultTbody');
  tbody.innerHTML = '';
  G.selected.forEach(r => {
    const cls = r['ìˆœìœ„'] === 1 ? 'rank-1' : r['ìˆœìœ„'] === 2 ? 'rank-2' : r['ìˆœìœ„'] === 3 ? 'rank-3' : '';
    tbody.insertAdjacentHTML('beforeend', `
      <tr class="${cls}">
        <td><strong>${r['ìˆœìœ„']}</strong></td>
        <td>${esc(r['ì„±ëª…'])}</td>
        <td>${esc(r['í•™ë…„'])}</td>
        <td class="text-nowrap">${esc(r['ì „ê³µ'])}</td>
        <td>${r['ì´ìˆ˜í•™ì ']}</td>
        <td>${r['ì¡¸ì—…ê¸°ì¤€í•™ì ']}</td>
        <td><strong>${r['ì´ìˆ˜ìœ¨']}%</strong></td>
        <td>${r['GPA']}</td>
        <td>${r['í•™ë…„ì ìˆ˜']}</td>
        <td>${r['ì´ìˆ˜ìœ¨ì ìˆ˜']}</td>
        <td>${r['ê°€ì‚°ì ']}</td>
        <td><strong>${r['ì´ì ']}</strong></td>
        <td class="check-mark text-center">${r['ì´ê³µê³„ë°©ì‚°']||''}</td>
        <td class="check-mark text-center">${r['ìê²©ì¦ì–´í•™']||''}</td>
        <td class="check-mark text-center">${r['ë´‰ì‚¬50h']||''}</td>
      </tr>`);
  });

  // ê²½ê³ 
  if (G.warnings.length > 0) {
    document.getElementById('warningSection').classList.remove('d-none');
    document.getElementById('warnCount').textContent = `íŒŒì‹± ì£¼ì˜ì‚¬í•­ (${G.warnings.length}ê±´)`;
    const wb = document.getElementById('warnTbody');
    wb.innerHTML = '';
    G.warnings.forEach(w => {
      wb.insertAdjacentHTML('beforeend',
        `<tr><td>${esc(w.name)}</td><td class="small">${esc(w.note)}</td></tr>`);
    });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íƒ­ 3: í†µê³„ ë¦¬í¬íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStatsTab(stats) {
  if (!stats) return;
  document.getElementById('statsEmpty').classList.add('d-none');
  document.getElementById('statsContent').classList.remove('d-none');

  // í•µì‹¬ ì§€í‘œ
  document.getElementById('statsMetrics').innerHTML = makeMetrics([
    { label: 'ì´ ì‹ ì²­ì',   value: stats.total_applicants + 'ëª…', icon: 'people' },
    { label: 'ìµœì¢… ì„ ë°œ',   value: stats.selected_count   + 'ëª…', icon: 'trophy', color: 'text-success' },
    { label: 'ì„ ë°œë¥ ',      value: stats.selection_rate   + '%',  icon: 'percent' },
    { label: 'í‰ê·  ì ìˆ˜',   value: stats.avg_score        + 'ì ', icon: 'star' },
    { label: 'í‰ê·  ì´ìˆ˜ìœ¨', value: stats.avg_completion   + '%',  icon: 'journal-check' },
  ]);

  // ê°€ì‚°ì  í˜„í™©
  document.getElementById('bonusMetrics').innerHTML = makeMetrics([
    { label: 'ì´ê³µê³„/ë°©ì‚° ì „ê³µì', value: stats.stem_count + 'ëª… (' + stats.stem_rate + '%)', icon: 'cpu' },
    { label: 'ìê²©ì¦/ì–´í•™ ì„±ì ',   value: stats.cert_count + 'ëª…', icon: 'award' },
    { label: 'ë´‰ì‚¬ 50h ì´ìƒ',      value: stats.vol_count  + 'ëª…', icon: 'heart' },
  ]);

  // í•™ë…„ë³„ ì°¨íŠ¸
  const gradeLabels = Object.keys(stats.grade_dist).sort().reverse();
  const gradeData   = gradeLabels.map(k => stats.grade_dist[k]);
  renderBarChart('gradeChart', gradeLabels, gradeData, 'ì„ ë°œ ì¸ì›', '#1a3a8f', gradeChartInst,
    inst => { gradeChartInst = inst; });

  // ì ìˆ˜ ë¶„í¬ ì°¨íŠ¸
  const scoreLabels = G.selected.map((_, i) => (i+1) + 'ìœ„');
  const scoreData   = G.selected.map(r => r['ì´ì ']);
  renderBarChart('scoreChart', scoreLabels, scoreData, 'ì´ì ', '#2e7d32', scoreChartInst,
    inst => { scoreChartInst = inst; });

  // ê³µì‹ ë³´ê³ ì„œ
  document.getElementById('reportBox').innerHTML = `
    <strong>í•œì˜ì í¬ë§ ì¥í•™ì¬ë‹¨ 2026ë…„ë„ ì¥í•™ìƒ ì„ ë°œ ê²°ê³¼ ë³´ê³ </strong><br><br>
    ë³¸ ì¬ë‹¨ì€ <strong>ìë¦½ì¤€ë¹„ì²­ë…„ì˜ ì‹¤ì§ˆì  ìë¦½ ì§€ì›</strong>ì„ ëª©ì ìœ¼ë¡œ,
    ëŒ€í•™ ì¡¸ì—…ì„ ì•ë‘” ìë¦½ì§€ì› ëŒ€ìƒì <strong>${stats.total_applicants}ëª…</strong>ì˜
    ì§€ì›ì„œë¥¼ ì‹¬ì‚¬í•˜ì˜€ìŠµë‹ˆë‹¤.<br><br>
    ê°ê´€ì  ì§€í‘œ(í•™ë…„ ì ìˆ˜, í•™ì—… ì´ìˆ˜ìœ¨)ì™€ ì‚¬íšŒì  ì—­ëŸ‰(ì´ê³µê³„ ì „ê³µ, ìê²©ì¦, ë´‰ì‚¬)ì„
    ì¢…í•©í•˜ì—¬ <strong>${stats.selected_count}ëª…</strong>ì„ ìµœì¢… ì„ ë°œí•˜ì˜€ìœ¼ë©°,
    ì„ ë°œìì˜ í‰ê·  ì ìˆ˜ëŠ” <strong>${stats.avg_score}ì </strong>
    (ìµœê³  ${stats.max_score}ì  / ìµœì € ${stats.min_score}ì ),
    í‰ê·  ì´ìˆ˜ìœ¨ì€ <strong>${stats.avg_completion}%</strong>ì…ë‹ˆë‹¤.<br><br>
    í›„ì›ì‚¬ <strong>ì‚¼ì–‘</strong>ì˜ ë°©ì‚°ê¸°ì—… íŠ¹ì„±ì„ ë°˜ì˜í•˜ì—¬
    ì´ê³µê³„Â·ë°©ì‚° ê´€ë ¨ ì „ê³µì <strong>${stats.stem_count}ëª… (${stats.stem_rate}%)</strong>ì—ê²Œ
    ê°€ì‚°ì ì´ ë¶€ì—¬ë˜ì—ˆìœ¼ë©°, ìê²©ì¦Â·ì–´í•™ ì„±ì  ë³´ìœ ì ${stats.cert_count}ëª…,
    ë´‰ì‚¬í™œë™ 50ì‹œê°„ ì´ìƒ ì´í–‰ì ${stats.vol_count}ëª…ì´ ì¶”ê°€ ê°€ì‚°ì ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.<br><br>
    ëª¨ë“  ì„ ë°œ ê³¼ì •ì€ ìë™í™” ì•Œê³ ë¦¬ì¦˜ì— ì˜í•´ íˆ¬ëª…í•˜ê²Œ ì²˜ë¦¬Â·ê¸°ë¡ë©ë‹ˆë‹¤.
    ì¥í•™ê¸ˆ ìˆ˜ì—¬ì‹ì€ <strong>2026ë…„ 4ì›” 30ì¼</strong>ì— ì§„í–‰ë  ì˜ˆì •ì…ë‹ˆë‹¤.<br><br>
    <em>ì´ì‚¬ì¥ ì „ë™ì§„ &nbsp;å° &nbsp;&nbsp; ì‚¬ë¬´êµ­ì¥ ì„ì¬ì˜ &nbsp;å°</em>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì°¨íŠ¸ í—¬í¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderBarChart(canvasId, labels, data, label, color, oldInst, setter) {
  if (oldInst) oldInst.destroy();
  const ctx = document.getElementById(canvasId).getContext('2d');
  setter(new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label, data, backgroundColor: color + 'cc', borderColor: color, borderWidth: 1 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  }));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSV ë‹¤ìš´ë¡œë“œ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ìƒì„±)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function downloadCSV(type) {
  const rows  = type === 'selected' ? G.selected : G.all;
  if (!rows || !rows.length) return;

  // í‘œì‹œìš© ì»¬ëŸ¼ (ë‚´ë¶€ ì •ë ¬ìš© ì»¬ëŸ¼ ì œì™¸)
  const exclude = new Set(['_í•™ë…„ìˆ«ì', '_ì´ìˆ˜ìœ¨ì •ë ¬']);
  const headers = Object.keys(rows[0]).filter(k => !exclude.has(k));

  const lines = [
    headers.join(','),
    ...rows.map(r => headers.map(h => {
      const v = r[h] ?? '';
      return /[,"\n]/.test(String(v)) ? `"${String(v).replace(/"/g, '""')}"` : v;
    }).join(','))
  ];

  // BOM ì¶”ê°€ (í•œê¸€ ì—‘ì…€ í˜¸í™˜)
  const blob = new Blob(['\uFEFF' + lines.join('\n')], { type: 'text/csv;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  const now  = new Date().toISOString().slice(0,10).replace(/-/g,'');
  a.download = type === 'selected'
    ? `í•œì˜ì í¬ë§ ì¥í•™ì¬ë‹¨_ì„ ë°œëª…ë‹¨_${now}.csv`
    : `í•œì˜ì í¬ë§ ì¥í•™ì¬ë‹¨_ì „ì²´ëª…ë‹¨_${now}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI í—¬í¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function makeMetrics(items) {
  return items.map(m => `
    <div class="col-sm-6 col-lg-auto flex-grow-1">
      <div class="card metric-card p-3 h-100">
        <div class="text-muted small"><i class="bi bi-${m.icon} me-1"></i>${m.label}</div>
        <div class="display-6 fw-bold mt-1 ${m.color||'text-dark'}">${m.value}</div>
      </div>
    </div>`).join('');
}

function setLoading(on, msg = '') {
  document.getElementById('loadingSection').style.display = on ? 'block' : 'none';
  document.getElementById('loadingText').textContent = msg;
  document.getElementById('uploadBtn').disabled = on;
}

function showAlert(type, html) {
  document.getElementById('alertBox').innerHTML =
    `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
       ${html}
       <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
     </div>`;
}

function clearAlert() {
  document.getElementById('alertBox').innerHTML = '';
}

function esc(str) {
  return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ ì´ì „ ì„ ë°œì ì œì™¸ ê´€ë¦¬ (localStorage ì˜ì†í™”) â”€â”€
const _EK = 'hanyang_excluded';
function loadExcluded() { try { return new Set(JSON.parse(localStorage.getItem(_EK)||'[]')); } catch { return new Set(); } }
function saveExcluded(s) { localStorage.setItem(_EK, JSON.stringify([...s])); }
function addToExcluded(names) { const s=loadExcluded(); names.forEach(n=>s.add(n)); saveExcluded(s); updateExcludeUI(); }
function clearExcluded() {
  if(!confirm('ì´ì „ ì„ ë°œ ëª…ë‹¨ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ˆê¸°í™” ì‹œ ì¤‘ë³µ ì„ ë°œ ë°©ì§€ê°€ ë¦¬ì…‹ë©ë‹ˆë‹¤.')) return;
  localStorage.removeItem(_EK); updateExcludeUI();
}
function updateExcludeUI() {
  const s=loadExcluded(), el=document.getElementById('excludeStatus'), btn=document.getElementById('excludeClearBtn');
  if(!el) return;
  if(s.size===0) {
    el.innerHTML='<i class="bi bi-people"></i> ì´ì „ ì„ ë°œì: <strong>ì—†ìŒ</strong> &nbsp;<span class="text-muted">(ì¤‘ë³µ ì„ ë°œ ë°©ì§€ ë¹„í™œì„±)</span>';
    el.className='text-secondary small py-1';
  } else {
    el.innerHTML='<i class="bi bi-person-x-fill text-danger"></i> ì´ì „ ì„ ë°œì <strong>'+s.size+'ëª…</strong>ì´ ì´ë²ˆ ì„ ë°œì—ì„œ ìë™ ì œì™¸ë©ë‹ˆë‹¤.';
    el.className='text-warning-emphasis small py-1 fw-semibold';
  }
  if(btn) btn.classList.toggle('d-none', s.size===0);
}
updateExcludeUI();
</script>
</body>
</html>
